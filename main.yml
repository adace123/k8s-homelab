- name: Create master node
  hosts: localhost
  vars:
    master_ip: 192.168.20.100
    git_repo_url: https://github.com/adace123/k8s-homelab.git
    git_ssh_private_key_name: github
    skip_brew_installs: false
    recreate_tls_cert: false
    k8s_base_domain: k8s.dev
  environment:
    KUBECONFIG: "{{ playbook_dir }}/kubeconfig" # this is generated by k3sup
  tasks:
    - name: Install required Brew packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      with_items:
        - kubectl
        - k3sup
        - helm
        - kubectx
        - vagrant
        - virtualbox
      when: "not skip_brew_installs"

    - name: Check master status
      shell: vagrant status master | grep running
      ignore_errors: yes
      register: master_status
      changed_when: "master_status.failed"

    - name: Start master
      shell: vagrant up
      when: "master_status.failed"

    - name: Check if k3s is running
      command: pgrep k3s
      ignore_errors: yes
      register: k3s_status
      delegate_to: master
      changed_when: "k3s_status.failed"

    - name: Install k3sup on master node and set k8s context
      command: "k3sup install --ip {{ master_ip }} --context k3s --k3s-extra-args '--no-deploy traefik' --user vagrant --ssh-key .vagrant/machines/master/virtualbox/private_key"
      when: "k3s_status.failed"

    - name: Set context
      command: kubectx k3s
      changed_when: "k3s_status.failed"

    - name: Add Helm repos
      community.kubernetes.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      with_items:
        - {'name': 'stable', 'url': 'https://charts.helm.sh/stable'}
        - {'name': 'argo', 'url': 'https://argoproj.github.io/argo-helm'}
        - {'name': 'traefik', 'url': 'https://helm.traefik.io/traefik'}
        - {'name': 'coredns', 'url': 'https://coredns.github.io/helm'}
        - {'name': 'jetstack', 'url': 'https://charts.jetstack.io'}

    - name: Create namespaces
      community.kubernetes.k8s:
        name: "{{ item }}"
        api_version: v1
        kind: Namespace
        state: present
      with_items:
        - prometheus-grafana
        - argo-cd
        - traefik
        - coredns
        - cert-manager

    - name: Install Traefik
      include_role:
        name: traefik

    - name: Setup CoreDNS
      include_role:
        name: coredns

    - name: Cert Manager
      include_role:
        name: cert-manager

    - name: Install ArgoCD
      include_role:
        name: argocd
