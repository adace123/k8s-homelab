- name: Create master node
  hosts: localhost
  vars:
    master_ip: 192.168.20.100
    git_repo_url: https://github.com/adace123/k8s-homelab.git
    skip_brew_installs: false
    flux_version: 1.2.0
  environment:
    KUBECONFIG: "{{ playbook_dir }}/kubeconfig" # this is generated by k3sup
  tasks:
    - name: Install required Brew packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      with_items:
        - kubectl
        - k3sup
        - helm
        - helmfile
        - fluxcd/tap/flux
        - kubectx
        - vagrant
      when: "not skip_brew_installs"

    - name: Install required pip packages
      pip:
        name: openshift
        state: present
      become: yes

    - name: Check master status
      shell: vagrant status master | grep running
      ignore_errors: yes
      register: master_status
      changed_when: "master_status.failed"

    - name: Start master
      shell: vagrant up
      when: "master_status.failed"

    - name: Check if k3s is running
      command: pgrep k3s
      ignore_errors: yes
      register: k3s_status
      delegate_to: master

    - name: Install k3sup on master node and set k8s context
      command: "k3sup install --ip {{ master_ip }} --merge --context k3s --k3s-extra-args '--no-deploy traefik' --user vagrant --ssh-key .vagrant/machines/master/virtualbox/private_key"
      when: "k3s_status.failed"

    - name: Set context
      command: kubectx k3s

    - name: Add Helm repos
      community.kubernetes.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      with_items:
        - {'name': 'stable', 'url': 'https://charts.helm.sh/stable'}
        - {'name': 'fluxcd', 'url': 'https://charts.fluxcd.io'}

    - name: Install Flux Helm chart
      community.kubernetes.helm:
        name: fluxcd
        chart_ref: fluxcd/flux
        create_namespace: yes
        release_namespace: flux
        wait: yes
        atomic: yes
        values:
          git:
            url: "{{ git_repo_url }}"
            path: manifests/

    - name: Download Flux Helm Operator CRD
      get_url:
        url: https://raw.githubusercontent.com/fluxcd/helm-operator/{{ flux_version }}/deploy/crds.yaml
        dest: /tmp/helm-operator-crds.yaml
      register: download_flux

    - name: Install Flux Helm Operator CRD
      community.kubernetes.k8s:
        state: present
        src: /tmp/helm-operator-crds.yaml
      when: download_flux.changed

    - name: Install Flux Operator chart
      community.kubernetes.helm:
        name: flux-helm-operator
        chart_ref: fluxcd/helm-operator
        create_namespace: yes
        release_namespace: flux
        wait: yes
        atomic: yes
        values:
          helm:
            versions: v3
